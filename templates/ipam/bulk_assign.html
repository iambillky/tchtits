<!--
File: templates/ipam/bulk_assign.html
Purpose: Bulk assign multiple IPs to a single device
Created: 2025-01-14
Author: DCMS Team

Revision History:
- v1.0.0: Initial creation with bulk assignment interface
          For when someone needs an entire /24 or multiple add-on IPs
-->

{% extends "base.html" %}

{% block title %}Bulk IP Assignment - IPAM{% endblock %}

{% block extra_css %}
<style>
    .bulk-header {
        background: linear-gradient(135deg, rgba(251, 146, 60, 0.1), rgba(245, 158, 11, 0.05));
        border: 1px solid rgba(251, 146, 60, 0.2);
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 30px;
    }
    
    .bulk-title {
        color: #fb923c;
        font-size: 1.5rem;
        font-weight: 600;
    }
    
    .range-preview {
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        padding: 15px;
        margin-top: 15px;
    }
    
    .preview-title {
        color: #fff;
        font-weight: 600;
        margin-bottom: 10px;
    }
    
    .ip-preview-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 8px;
        margin-top: 10px;
    }
    
    .ip-preview-item {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        padding: 5px 10px;
        border-radius: 4px;
        font-family: 'Courier New', monospace;
        font-size: 0.85rem;
        text-align: center;
    }
    
    .ip-available {
        color: #10b981;
        border-color: rgba(34, 197, 94, 0.3);
    }
    
    .ip-unavailable {
        color: #ef4444;
        border-color: rgba(239, 68, 68, 0.3);
        text-decoration: line-through;
        opacity: 0.6;
    }
    
    .stats-box {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 8px;
        padding: 15px;
        text-align: center;
    }
    
    .stats-number {
        font-size: 2rem;
        font-weight: 700;
        color: #fff;
    }
    
    .stats-label {
        color: #8b92a5;
        font-size: 0.9rem;
    }
    
    .warning-box {
        background: rgba(239, 68, 68, 0.1);
        border: 1px solid rgba(239, 68, 68, 0.3);
        border-radius: 8px;
        padding: 15px;
        margin-top: 20px;
    }
    
    .warning-title {
        color: #ef4444;
        font-weight: 600;
        margin-bottom: 8px;
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">Bulk IP Assignment</h1>
    <p class="page-subtitle">Assign multiple IPs to a single device at once</p>
</div>

<div class="bulk-header">
    <div class="bulk-title">üì¶ Bulk Assignment Tool</div>
    <p style="color: #e4e6eb; margin-top: 10px;">
        Use this tool when you need to assign many IPs to a single device, such as:
    </p>
    <ul style="color: #8b92a5; margin-bottom: 0;">
        <li>Multiple add-on IPs for a dedicated server</li>
        <li>A block of IPs for a VPS hypervisor</li>
        <li>A range of IPs for a customer's colocation</li>
    </ul>
</div>

<!-- Assignment Form -->
<div class="card">
    <div class="card-body">
        <form method="POST" action="{{ url_for('ipam.bulk_assign') }}" id="bulkAssignForm">
            {{ form.hidden_tag() }}
            
            <!-- IP Range Input -->
            <div class="mb-3">
                {{ form.ip_range.label(class="form-label") }}
                {{ form.ip_range(class="form-control", onchange="previewRange()") }}
                {% if form.ip_range.errors %}
                    <div class="text-danger">
                        {% for error in form.ip_range.errors %}
                            <small>{{ error }}</small>
                        {% endfor %}
                    </div>
                {% endif %}
                <small class="form-text text-muted">
                    Examples: 192.168.1.0/24 (256 IPs) or 192.168.1.10-192.168.1.20 (11 IPs)
                </small>
            </div>
            
            <!-- Device Information -->
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        {{ form.device_type.label(class="form-label") }}
                        {{ form.device_type(class="form-select") }}
                        {% if form.device_type.errors %}
                            <div class="text-danger">
                                {% for error in form.device_type.errors %}
                                    <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        {{ form.device_id.label(class="form-label") }}
                        {{ form.device_id(class="form-control") }}
                        {% if form.device_id.errors %}
                            <div class="text-danger">
                                {% for error in form.device_id.errors %}
                                    <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                        {% endif %}
                        <small class="form-text text-muted">
                            The device that will receive all these IPs
                        </small>
                    </div>
                </div>
            </div>
            
            <!-- Notes -->
            <div class="mb-3">
                {{ form.notes.label(class="form-label") }}
                {{ form.notes(class="form-control") }}
                {% if form.notes.errors %}
                    <div class="text-danger">
                        {% for error in form.notes.errors %}
                            <small>{{ error }}</small>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
            
            <!-- Options -->
            <div class="mb-3">
                <div class="form-check">
                    {{ form.skip_unavailable(class="form-check-input") }}
                    {{ form.skip_unavailable.label(class="form-check-label") }}
                </div>
                <small class="form-text text-muted">
                    If checked, already assigned IPs will be skipped. Otherwise, the operation will fail if any IP is unavailable.
                </small>
            </div>
            
            <!-- Range Preview -->
            <div class="range-preview" id="rangePreview" style="display: none;">
                <div class="preview-title">Range Preview</div>
                <div class="row mb-3">
                    <div class="col-md-3">
                        <div class="stats-box">
                            <div class="stats-number" id="totalCount">0</div>
                            <div class="stats-label">Total IPs</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stats-box">
                            <div class="stats-number" id="availableCount" style="color: #10b981;">0</div>
                            <div class="stats-label">Available</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stats-box">
                            <div class="stats-number" id="unavailableCount" style="color: #ef4444;">0</div>
                            <div class="stats-label">Unavailable</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stats-box">
                            <div class="stats-number" id="willAssignCount" style="color: #fb923c;">0</div>
                            <div class="stats-label">Will Assign</div>
                        </div>
                    </div>
                </div>
                
                <div class="preview-title">IP Addresses in Range</div>
                <div class="ip-preview-grid" id="ipList">
                    <!-- IPs will be loaded here via JavaScript -->
                </div>
            </div>
            
            <!-- Warning for large assignments -->
            <div class="warning-box" id="warningBox" style="display: none;">
                <div class="warning-title">‚ö†Ô∏è Large Assignment Warning</div>
                <p style="color: #e4e6eb; margin-bottom: 0;">
                    You are about to assign <span id="warningCount">0</span> IP addresses to a single device.
                    This action cannot be easily undone. Please confirm this is intentional.
                </p>
            </div>
            
            <!-- Submit Buttons -->
            <div class="d-flex gap-2 mt-3">
                <button type="button" class="btn btn-primary" onclick="validateAndSubmit()">
                    Check Availability
                </button>
                {{ form.submit(class="btn btn-success", id="submitBtn", disabled=true) }}
                <a href="{{ url_for('ipam.index') }}" class="btn btn-secondary">Cancel</a>
            </div>
        </form>
    </div>
</div>

<!-- Help Section -->
<div class="card mt-3">
    <div class="card-body">
        <h5 class="card-title">Bulk Assignment Examples</h5>
        <ul class="mb-0">
            <li><strong>/29 subnet (8 IPs):</strong> 208.76.84.192/29 - Small block for a server</li>
            <li><strong>/28 subnet (16 IPs):</strong> 208.76.84.192/28 - VPS hypervisor pool</li>
            <li><strong>/27 subnet (32 IPs):</strong> 208.76.84.192/27 - Larger allocation</li>
            <li><strong>Range notation:</strong> 208.76.84.100-208.76.84.110 - Specific IP range</li>
        </ul>
        <div class="alert alert-info mt-3">
            <strong>Note:</strong> Maximum 1024 IPs can be assigned in a single operation.
            Gateway, network, and broadcast addresses will be automatically excluded.
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
let availabilityChecked = false;

function previewRange() {
    const rangeInput = document.getElementById('ip_range').value;
    if (!rangeInput) {
        document.getElementById('rangePreview').style.display = 'none';
        return;
    }
    
    // Parse the range
    let totalIPs = 0;
    if (rangeInput.includes('/')) {
        // CIDR notation
        const cidr = parseInt(rangeInput.split('/')[1]);
        totalIPs = Math.pow(2, 32 - cidr);
    } else if (rangeInput.includes('-')) {
        // Range notation - simplified calculation
        totalIPs = 10; // Would need to actually calculate
    }
    
    // Update preview
    document.getElementById('rangePreview').style.display = 'block';
    document.getElementById('totalCount').textContent = totalIPs;
    
    // Show warning for large assignments
    if (totalIPs > 32) {
        document.getElementById('warningBox').style.display = 'block';
        document.getElementById('warningCount').textContent = totalIPs;
    } else {
        document.getElementById('warningBox').style.display = 'none';
    }
    
    // Reset checked state
    availabilityChecked = false;
    document.getElementById('submitBtn').disabled = true;
}

function validateAndSubmit() {
    const rangeInput = document.getElementById('ip_range').value;
    if (!rangeInput) {
        alert('Please enter an IP range');
        return;
    }
    
    // In production, this would make an AJAX call to check availability
    alert('Checking availability of IPs in range...\n\nIn production, this would verify each IP.');
    
    // Simulate check
    availabilityChecked = true;
    document.getElementById('submitBtn').disabled = false;
    document.getElementById('availableCount').textContent = '8';
    document.getElementById('unavailableCount').textContent = '2';
    document.getElementById('willAssignCount').textContent = '8';
    
    // Show some sample IPs
    const ipList = document.getElementById('ipList');
    ipList.innerHTML = `
        <div class="ip-preview-item ip-available">192.168.1.1</div>
        <div class="ip-preview-item ip-available">192.168.1.2</div>
        <div class="ip-preview-item ip-unavailable">192.168.1.3</div>
        <div class="ip-preview-item ip-available">192.168.1.4</div>
        <div class="ip-preview-item ip-available">192.168.1.5</div>
        <div class="ip-preview-item ip-unavailable">192.168.1.6</div>
        <div class="ip-preview-item ip-available">192.168.1.7</div>
        <div class="ip-preview-item ip-available">192.168.1.8</div>
        <div class="ip-preview-item ip-available">192.168.1.9</div>
        <div class="ip-preview-item ip-available">192.168.1.10</div>
    `;
}

// Confirm before submission
document.getElementById('bulkAssignForm').addEventListener('submit', function(e) {
    if (!availabilityChecked) {
        e.preventDefault();
        alert('Please check availability first');
        return false;
    }
    
    const count = document.getElementById('willAssignCount').textContent;
    if (!confirm(`Are you sure you want to assign ${count} IPs to this device?`)) {
        e.preventDefault();
        return false;
    }
});
</script>
{% endblock %}